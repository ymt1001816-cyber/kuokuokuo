<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Seoul & Osaka Trip ğŸ‡°ğŸ‡·ğŸ‡¯ğŸ‡µ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&family=Noto+Sans+TC:wght@500;700;900&display=swap');
        body { 
            -webkit-tap-highlight-color: transparent; 
            background-color: #FFFBEB;
            font-family: 'Nunito', 'Noto Sans TC', sans-serif;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
        
        /* Subway Line Colors */
        .line-1 { background-color: #0052A4; color: white; }
        .line-2 { background-color: #00A84D; color: white; }
        .line-3 { background-color: #EF7C1C; color: white; }
        .line-4 { background-color: #00A5DE; color: white; }
        .line-5 { background-color: #996CAC; color: white; }
        .line-arex { background-color: #0090D2; color: white; }
        .line-default { background-color: #555; color: white; }
    </style>
</head>
<body class="text-stone-800 font-bold antialiased">
    <div id="root"></div>

    <!-- React & Firebase Imports -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.292.0",
                "firebase/app": "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js",
                "firebase/analytics": "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js"
            }
        }
    </script>
    <script type="module" src="https://esm.sh/run" defer></script>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            MapPin, Navigation, Car, Utensils, Camera, Ticket, Bed, Plane, Train, 
            AlertCircle, ShoppingBag, User, Cake, Gift, Coffee, ArrowRight, 
            Scissors, Bell, Plus, CheckCircle, Trash2, Sun, Cloud, CloudRain, 
            Sparkles, Heart, ChevronRight, Image as ImageIcon, CreditCard, Info,
            Edit3, Save, X, ArrowUp, ArrowDown, Tag, Umbrella, Map as MapIcon, ExternalLink
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getFirestore, doc, setDoc, onSnapshot, collection } from 'firebase/firestore';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getAnalytics } from 'firebase/analytics';

        // --- ğŸ”¥ FIREBASE CONFIG (å·²ç‚ºæ‚¨å¡«å…¥ï¼Œç¢ºä¿åŒæ­¥åŠŸèƒ½æ­£å¸¸) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDxDv2JSKCcx3orWaf7GTVINwndKdyjRiA",
            authDomain: "kuofamily-4ba8d.firebaseapp.com",
            projectId: "kuofamily-4ba8d",
            storageBucket: "kuofamily-4ba8d.firebasestorage.app",
            messagingSenderId: "423129206006",
            appId: "1:423129206006:web:3d9dd27b60205803d4f0d7",
            measurementId: "G-GNTBPGDJ81"
        };

        // --- 1. åˆå§‹åŒ–è³‡æ–™çµæ§‹ ---
        const initialTripData = {
            title: "SEOUL & OSAKA TRIP",
            lastUpdated: Date.now(),
            checklist: [
                { id: 1, text: "eSIM è¨­å®š QR Code ğŸ“±", done: false, img: null },
                { id: 2, text: "T-Money äº¤é€šå¡ ğŸ’³", done: false, img: null },
                { id: 3, text: "Q-Code å…¥å¢ƒå¡ ğŸ›‚", done: false, img: null },
                { id: 4, text: "è¬ç”¨è½‰æ¥é ­ ğŸ”Œ", done: false, img: null },
                { id: 5, text: "ç¢ºèªçˆ¸çˆ¸æ©Ÿç¥¨ âœˆï¸", done: false, img: null }
            ],
            tickets: {
                flights: [
                    { id: "f1", traveler: "éƒ­å°ç¾", airline: "China Airlines", code: "CI 260", origin: "TSA æ¾å±±", dest: "GMP é‡‘æµ¦", depTime: "09:20", arrTime: "12:25", seat: "å•†å‹™è‰™", bookingRef: "E426BQ", terminal: "Int'l", icon: "Plane" },
                    { id: "f2", traveler: "çˆ¸çˆ¸", airline: "EVA Air", code: "BR 172", origin: "KHH é«˜é›„", dest: "ICN ä»å·", depTime: "15:45", arrTime: "19:40", seat: "å•†å‹™è‰™ 02K", bookingRef: "A4F5EH", terminal: "T1", icon: "Plane" },
                    { id: "f3", traveler: "çˆ¸çˆ¸ (To Osaka)", airline: "Peach Aviation", code: "MM 705", origin: "ICN ä»å·", dest: "KIX å¤§é˜ª", depTime: "11:45", arrTime: "13:50", seat: "æ¨‚æ¡ƒèˆªç©º", bookingRef: "è«‹ç¢ºèªé›»å­æ©Ÿç¥¨", terminal: "T1", icon: "Plane" },
                    { id: "f4", traveler: "å°ç¾ & Uncle (To Osaka)", airline: "Korean Air å¤§éŸ“èˆªç©º", code: "KE 725", origin: "ICN ä»å·", dest: "KIX å¤§é˜ª", depTime: "15:10", arrTime: "17:00", seat: "ç¶“æ¿Ÿè‰™", bookingRef: "è«‹ç¢ºèªé›»å­æ©Ÿç¥¨", terminal: "T2", icon: "Plane" }
                ],
                hotels: [
                    { id: "h1", name: "RYSE, Autograph Collection", koName: "ë¼ì´ì¦ˆ ì˜¤í† ê·¸ë˜í”„ ì»¬ë ‰ì…˜", address: "130 Yanghwa-ro, Mapo-gu, Seoul", phone: "+82 2-330-7700", checkIn: "12/11 - 12/15", bookingRef: "Bonvoy-889922", notes: "å«æ—©é¤ (æ¯æ—¥ 07:00-10:00)ã€‚Uncle 12/10 å·²å…¥ä½ã€‚", icon: "Bed" },
                    { id: "h2", name: "å¤§é˜ªé£¯åº— (å¾…å®š)", koName: "Osaka Hotel TBD", address: "Osaka, Japan", phone: "", checkIn: "12/15 - 12/20", bookingRef: "", notes: "å°šæœªé è¨‚", icon: "Bed" }
                ],
                reservations: [
                    { id: "r1", name: "Schedule Clinic (é†«ç¾)", time: "12/15 10:00", party: "å°ç¾ + Uncle", location: "ç‹é·—äº­", bookingRef: "é ç´„ç¢ºèªä¸­", icon: "Sparkles", address: "Gangnam-gu, Dosan-daero 49-gil 11, 3F" },
                    { id: "r2", name: "Wuga (ç‰›å®¶)", time: "12/13 18:00", party: "3äºº (Me, Dad, Uncle)", location: "å³¶å±±å…¬åœ’", bookingRef: "MEIYU KUO", phone: "+1 415-909-8379", platform: "CatchTable", icon: "Utensils" },
                    { id: "r3", name: "yhyun_hair (å‰ªé«®)", time: "12/11 11:00", party: "Uncle", location: "å»¶å—æ´", bookingRef: "1059456147", notes: "Cut + Down perm", icon: "Scissors" },
                    { id: "r4", name: "Sinsa Kkotgedang (é†¬èŸ¹)", time: "12/14 18:30", party: "3äºº", location: "ç‹é·—äº­", bookingRef: "é›»è©±/ç¾å ´", icon: "Utensils" }
                ]
            },
            days: [
                {
                    day: 1, date: "12/11 (å››)", location: "é¦–çˆ¾ - å¼˜å¤§", cityCode: "SEOUL",
                    events: [
                        { id: 101, type: 'beauty', time: '11:00', title: 'Uncle å‰ªé ­é«® ğŸ’‡â€â™‚ï¸', koTitle: 'yhyun_hair', location: 'å»¶å—æ´', coords: 'yhyun_hair', description: "é ç´„è€…: Yuen chun Kuo\nç·¨è™Ÿ: 1059456147" },
                        { id: 102, type: 'flight', time: '12:25', title: 'å°ç¾æŠµé”é‡‘æµ¦ ğŸ›¬', koTitle: 'GMP Airport', flightInfo: { code: 'CI 260', route: 'TSA 09:20 -> GMP 12:25' }, location: 'é‡‘æµ¦æ©Ÿå ´', coords: 'Gimpo International Airport', description: 'å…¥å¢ƒå¾Œæ­ AREX å»å¼˜å¤§ã€‚' },
                        { id: 1021, type: 'commute', from: 'é‡‘æµ¦æ©Ÿå ´', to: 'å¼˜å¤§ RYSE', options: [{type:'subway', line:'AREX', time:'14åˆ†', price:'â‚©1,450', desc:'æ©Ÿå ´å¿«ç·š (æ™®é€šè»Š) ç›´é”ã€‚'}, {type:'taxi', time:'25åˆ†', price:'â‚©15,000', desc:'Uber / Kakao Taxi (è¡Œæå¤šæ¨è–¦)ã€‚'}] },
                        { id: 103, type: 'meeting', time: '13:30', title: 'RYSE é£¯åº—æœƒåˆ ğŸ¨', location: 'RYSE Lobby', coords: 'RYSE Autograph Collection', description: 'Uncle æ˜¨å¤©å·²å…¥ä½ï¼Œç›´æ¥å»é£¯åº—æ‰¾ä»–æ”¾è¡Œæã€‚' },
                        { id: 104, type: 'shopping', time: '15:00', title: 'å¼˜å¤§éŸ“ç‰Œå·¡ç¦® ğŸ›ï¸', location: 'å¼˜å¤§å•†åœˆ', coords: 'Hongik University Station', linePay: true, coupon: "éƒ¨åˆ†åº—å®¶å¯ç”¨ Alipay+ å„ªæƒ ", description: 'å¿…é€›: MarithÃ©, What it isNt, Gentle Monster, Objectã€‚' },
                        { id: 106, type: 'flight', time: '19:40', title: 'çˆ¸çˆ¸æŠµé”ä»å· ğŸ›¬', flightInfo: { code: 'BR 172', route: 'KHH 15:45 -> ICN 19:40' }, location: 'ä»å·æ©Ÿå ´ T1', coords: 'Incheon International Airport Terminal 1' },
                        { id: 1061, type: 'commute', from: 'ä»å·æ©Ÿå ´ T1', to: 'å¼˜å¤§å…¥å£ç«™', guide: "AREX æ­ä¹˜æ”»ç•¥ (çµ¦çˆ¸çˆ¸)ï¼š\n1. å…¥å¢ƒå¾Œè·Ÿéš¨é»ƒè‰²æ–‡å­—ã€ŒAirport Railroadã€æŒ‡æ¨™ã€‚\n2. çˆ¸çˆ¸è«‹æ­ã€Œè—è‰²ã€çš„æ™®é€šè»Š (All Stop Train)ã€‚\n3. å¼˜å¤§ç«™ä¸‹è»Šå¾Œï¼Œå¾ 9 è™Ÿå‡ºå£å‡ºä¾†ã€‚", options: [{type:'subway', line:'AREX', time:'53åˆ†', price:'â‚©4,750', desc:'æ™®é€šè»Š (è—è‰²)'}, {type:'taxi', time:'60åˆ†', price:'â‚©65,000', desc:'è¨ˆç¨‹è»Šç›´é”'}] },
                        { id: 107, type: 'food', time: '21:30', title: 'ä¿æ‰¿æœƒé¤¨ (å®µå¤œ) ğŸ²', koTitle: 'ë³´ìŠ¹íšŒê´€ í™ëŒ€ì§ì˜ì ', location: 'å¼˜å¤§åº—', coords: 'ë³´ìŠ¹íšŒê´€ í™ëŒ€ì§ì˜ì ', description: 'çˆ¸çˆ¸æ”¾å®Œè¡Œæåƒç†±é¨°é¨°æ¹¯é£¯ã€‚' }
                    ]
                },
                {
                    day: 2, date: "12/12 (äº”)", location: "é¦–çˆ¾ - è–æ°´æ´", cityCode: "SEOUL",
                    events: [
                        { id: 200, type: 'food', time: '10:00', title: 'é£¯åº—æ—©é¤ ğŸ³', location: 'RYSE', description: 'æ‚ é–’åƒæ—©é¤å†å‡ºé–€ã€‚' },
                        { id: 201, type: 'commute', from: 'å¼˜å¤§', to: 'è–æ°´æ´', options: [{type:'subway', line:'2è™Ÿç·š', time:'35åˆ†', price:'â‚©1,500', desc:'ç›´é” (å¼˜å¤§å…¥å£->è–æ°´)ã€‚'}, {type:'taxi', time:'50åˆ†+', price:'â‚©25,000', desc:'Uber/Taxi (é¦–çˆ¾ç™½å¤©æ˜“å¡è»Š)ã€‚'}] },
                        { id: 202, type: 'sightseeing', time: '11:00', title: 'è–æ°´æ´æ•£ç­– ğŸ“¸', location: 'è–æ°´æ´', coords: 'Seongsu-dong Cafe Street', description: 'é€›è¡—ã€æ‹è²¼æ©Ÿ (Photoism)ã€‚' },
                        { id: 203, type: 'shopping', time: '11:30', title: 'SAMO ONDOH ğŸ‘œ', location: 'æ——è‰¦åº—', coords: 'SAMO ONDOH Seongsu', coupon: "è¨˜å¾—é€€ç¨…", description: 'ä»»å‹™ï¼šè²·åŒ…åŒ… (è¨˜å¾—é€€ç¨…)ã€‚' },
                        { id: 204, type: 'food', time: '13:00', title: 'è–æ°´é¦¬éˆ´è–¯æ’éª¨æ¹¯ ğŸ–', location: 'æ’éšŠååº—', coords: 'ì†Œë¬¸ë‚œì„±ìˆ˜ê°ìíƒ•', description: 'åˆé¤ï¼šæ’éª¨æ¹¯æˆ–è–æ°´è±¬è…³ (ì„±ìˆ˜ì¡±ë°œ)ã€‚' },
                        { id: 205, type: 'commute', from: 'è–æ°´', to: 'æ–°è¨­æ´', options: [{type:'taxi', time:'15åˆ†', price:'â‚©10,000', desc:'Uber/Taxi (è·é›¢è¿‘ï¼Œæ¨è–¦æ­è»Š)ã€‚'}, {type:'subway', line:'2è™Ÿç·š', time:'20åˆ†', price:'â‚©1,400', desc:'2è™Ÿç·šè–æ°´æ”¯ç·šã€‚'}] },
                        { id: 206, type: 'food', time: '18:00', title: 'Sinsoldon çƒ¤è‚‰ ğŸ¥“', koTitle: 'ì‹ ì†”ëˆ', location: 'æ–°è¨­æ´', coords: 'ì‹ ì†”ëˆ', description: 'æ™šé¤åƒé«˜å“è³ªéŸ“å¼çƒ¤è‚‰ã€‚\nå‚™è¨»: å¯è«‹é£¯åº—æ«ƒæª¯å¹«å¿™é›»è©±ç¢ºèªè¨‚ä½ã€‚' }
                    ]
                },
                {
                    day: 3, date: "12/13 (å…­)", location: "é¦–çˆ¾ - ç”Ÿæ—¥å¿«æ¨‚", cityCode: "SEOUL",
                    events: [
                        { id: 300, type: 'food', time: '10:00', title: 'é£¯åº—æ—©é¤ ğŸ‚', location: 'RYSE', description: 'ç”Ÿæ—¥å¿«æ¨‚ï¼' },
                        { id: 301, type: 'commute', from: 'å¼˜å¤§', to: 'äº¬æ±å¸‚å ´', options: [{type:'taxi', time:'30åˆ†', price:'â‚©18,000', desc:'Uber/Taxi (æ¨è–¦ï¼ç›´é”å¸‚å ´é–€å£)ã€‚'}, {type:'subway', time:'40åˆ†', price:'â‚©1,600', desc:'éœ€è½‰ä¹˜ã€‚'}] },
                        { id: 302, type: 'food', time: '10:30', title: 'å®‰æ±å®¶ æ‰‹å·¥éºµ ğŸœ', location: 'äº¬æ±å¸‚å ´ B1', coords: 'Gyeongdong Market', description: 'å¿…åƒï¼šåˆ€å‰Šéºµã€ç™½èœç…é¤…ã€‚' },
                        { id: 3021, type: 'coffee', time: '11:30', title: 'Starbucks 1960 â˜•', location: 'äº¬æ±å¸‚å ´ 3F', coords: 'Starbucks Gyeongdong 1960', description: 'å»¢æ£„åŠ‡é™¢æ”¹å»ºï¼Œå¿…æ‹ï¼' },
                        { id: 303, type: 'commute', from: 'äº¬æ±å¸‚å ´', to: 'æ˜æ´', options: [{type:'subway', line:'1è™Ÿç·š', time:'20åˆ†', price:'â‚©1,400', desc:'ç›´é” (ç¥­åŸºæ´ -> å¸‚å»³)ã€‚'}, {type:'taxi', time:'25åˆ†', price:'â‚©12,000', desc:'Uber/Taxiã€‚'}] },
                        { id: 3031, type: 'shopping', time: '13:30', title: 'æ¨‚å¤©å…ç¨…åº— & æ˜æ´ ğŸ’„', location: 'æ˜æ´', coords: 'Lotte Duty Free Main Store', linePay: true, coupon: "LDF PAY / ä¿¡ç”¨å¡å„ªæƒ ", description: 'å…ç¨…åº—é€›å®Œé€›æ˜æ´å•†åœˆã€‚' },
                        { id: 304, type: 'commute', from: 'æ˜æ´', to: 'å³¶å±±å…¬åœ’', options: [{type:'taxi', time:'25åˆ†', price:'â‚©15,000', desc:'Uber/Taxi (éæ¼¢æ±Ÿå»ºè­°æ­è»Š)ã€‚'}, {type:'subway', line:'3è™Ÿç·š', time:'45åˆ†', price:'â‚©1,500', desc:'éœ€è½‰ä¹˜ã€‚'}] },
                        { id: 305, type: 'food', time: '18:00', title: 'ç”Ÿæ—¥æ™šé¤: ç‰›å®¶ ğŸ¥©', koTitle: 'ìš°ê°€ Wuga', location: 'å³¶å±±å…¬åœ’', coords: 'Wuga Seoul', description: 'CatchTable è¨‚ä½: MEIYU KUO (3äºº)ã€‚\nç‰¹è‰²: ç±³å…¶æ—æ¨è–¦ä¹¾å¼ç†ŸæˆéŸ“ç‰›ã€‚' },
                        { id: 306, type: 'cake', time: '19:30', title: 'è²·ç”Ÿæ—¥è›‹ç³• ğŸ°', location: 'å³¶å±±å…¬åœ’é™„è¿‘', coords: 'Dosan Mammamia', description: 'æ¨è–¦: Dosan Mammamia æˆ– Nudakeã€‚' }
                    ]
                },
                {
                    day: 4, date: "12/14 (æ—¥)", location: "é¦–çˆ¾ - æ±Ÿå—", cityCode: "SEOUL",
                    events: [
                        { id: 400, type: 'food', time: '10:00', title: 'é£¯åº—æ—©é¤ ğŸ³', location: 'RYSE', description: 'æ‚ é–’åƒæ—©é¤ã€‚' },
                        { id: 401, type: 'commute', from: 'å¼˜å¤§', to: 'æ±Ÿå—', options: [{type:'subway', line:'9è™Ÿç·š', time:'40åˆ†', price:'â‚©1,600', desc:'å ‚å±±è½‰ä¹˜æ€¥è¡Œ'}, {type:'taxi', time:'40åˆ†+', price:'â‚©22,000', desc:'Uber/Taxi (é€±æ—¥æ±Ÿå—å¯èƒ½å¡è»Š)ã€‚'}] },
                        { id: 402, type: 'shopping', time: '11:00', title: 'æ–°ä¸–ç•Œç™¾è²¨ æ±Ÿå—åº— ğŸ›ï¸', location: 'æ±Ÿå—åº—', coords: 'Shinsegae Department Store Gangnam', linePay: true, coupon: "é€€ç¨…+95æŠ˜", description: 'é€› B1 ç”œé»å€ã€‚' },
                        { id: 4021, type: 'food', time: '13:00', title: 'åˆé¤ (å°šæœªç¢ºå®š) ğŸ½ï¸', koTitle: 'TBD', location: 'é«˜é€Ÿå·´å£«ç«™/æ±Ÿå—é™„è¿‘', coords: 'Famille Station', description: 'å¾…å®šï¼Œå¯çœ‹ç•¶å¤©å¿ƒæƒ…æ±ºå®šã€‚\næ¨è–¦ï¼šFamille Station (íŒŒë¯¸ì—ìŠ¤í…Œì´ì…˜)ã€‚' },
                        { id: 403, type: 'sightseeing', time: '15:00', title: 'ç‹é·—äº­ç¾…å¾·å¥§ ğŸ•¶ï¸', location: 'Apgujeong Rodeo', coords: 'Apgujeong Rodeo Street', description: 'æ­è¨ˆç¨‹è»Šéå»ç´„10åˆ†é˜ã€‚' },
                        { id: 404, type: 'food', time: '18:30', title: 'Sinsa Kkotgedang ğŸ¦€', location: 'é†¬èŸ¹', coords: 'ì‹ ì‚¬ê½ƒê²Œë‹¹', description: 'æ™šé¤åƒé†¬æ²¹èƒèŸ¹ã€‚\nè«‹ææ—©å‰å¾€ã€‚' }
                    ]
                },
                {
                    day: 5, date: "12/15 (ä¸€)", location: "é¦–çˆ¾ -> å¤§é˜ª", cityCode: "SEOUL",
                    events: [
                        { id: 500, type: 'misc', time: '08:30', title: 'èµ·åºŠ & æ—©é¤ ğŸ§³', location: 'RYSE', description: 'æ•´ç†è¡Œæï¼ŒCheck-outã€‚' },
                        { id: 501, type: 'commute', from: 'å¼˜å¤§', to: 'Schedule Clinic', options: [{type:'taxi', time:'35åˆ†', price:'â‚©20,000', desc:'Uber (æ¨è–¦)'}, {type:'subway', time:'45åˆ†', price:'â‚©1,600', desc:'è½‰ä¹˜å¤šæ¬¡'}] },
                        { id: 502, type: 'beauty', time: '10:00', title: 'Schedule Clinic âœ¨', location: 'ç‹é·—äº­', coords: 'ìŠ¤ì¼€ì¤„í´ë¦¬ë‹‰', description: 'å°ç¾ & Uncle é†«ç¾ã€‚\nåœ°å€: æ±Ÿå—å€å³¶å±±å¤§è·¯ 49è¡— 11 3F' },
                        { id: 503, type: 'flight', time: '11:45', title: 'çˆ¸çˆ¸é£›å¾€å¤§é˜ª ğŸ›«', flightInfo: { code: 'MM 705', route: 'ICN 11:45 -> KIX 13:50' }, location: 'ä»å·æ©Ÿå ´ T1', coords: 'Incheon International Airport', description: 'çˆ¸çˆ¸è¨˜å¾— 09:00 å‰è¦å‡ºç™¼å»æ©Ÿå ´ã€‚' },
                        { id: 504, type: 'flight', time: '15:10', title: 'å°ç¾ & Uncle é£›å¤§é˜ª ğŸ›«', flightInfo: { code: 'KE 725', route: 'ICN 15:10 -> KIX 17:00' }, location: 'ä»å·æ©Ÿå ´ T2', coords: 'Incheon International Airport Terminal 2', description: 'åšå®Œè‡‰æ­è¨ˆç¨‹è»Šå»æ©Ÿå ´ã€‚\n**æ³¨æ„: å¤§éŸ“èˆªç©ºåœ¨ T2**' }
                    ]
                },
                // --- å¤§é˜ªè¡Œç¨‹ (ç•™ç™½) ---
                { day: 6, date: "12/16 (äºŒ)", location: "å¤§é˜ª Osaka", cityCode: "OSAKA", events: [{ id: 601, time: '10:00', title: 'å¤§é˜ªè¡Œç¨‹ (å¾…å®‰æ’)', location: 'Osaka', description: 'è‡ªç”±å®‰æ’' }] },
                { day: 7, date: "12/17 (ä¸‰)", location: "å¤§é˜ª Osaka", cityCode: "OSAKA", events: [{ id: 701, time: '10:00', title: 'å¤§é˜ªè¡Œç¨‹ (å¾…å®‰æ’)', location: 'Osaka', description: 'è‡ªç”±å®‰æ’' }] },
                { day: 8, date: "12/18 (å››)", location: "å¤§é˜ª Osaka", cityCode: "OSAKA", events: [{ id: 801, time: '10:00', title: 'å¤§é˜ªè¡Œç¨‹ (å¾…å®‰æ’)', location: 'Osaka', description: 'è‡ªç”±å®‰æ’' }] },
                { day: 9, date: "12/19 (äº”)", location: "å¤§é˜ª Osaka", cityCode: "OSAKA", events: [{ id: 901, time: '10:00', title: 'å¤§é˜ªè¡Œç¨‹ (å¾…å®‰æ’)', location: 'Osaka', description: 'è‡ªç”±å®‰æ’' }] },
                { day: 10, date: "12/20 (å…­)", location: "å¤§é˜ª Osaka", cityCode: "OSAKA", events: [{ id: 1001, time: '10:00', title: 'æº–å‚™è¿”å°', location: 'KIX', description: 'è‡ªç”±å®‰æ’' }] }
            ]
        };

        // --- 2. Helper Functions ---
        const getIconComponent = (iconName) => {
            const icons = { Plane, Bed, Sparkles, Utensils, Scissors, Train, Car, Camera, ShoppingBag, User, Cake, Gift, Coffee, Info };
            return icons[iconName] || MapPin;
        };

        const openUber = (destination) => {
            const encodedDest = encodeURIComponent(destination);
            // å˜—è©¦æ‰“é–‹ Uber Universal Linkï¼Œè‹¥ç„¡å®‰è£æœƒè·³è½‰ç¶²é 
            window.location.href = `https://m.uber.com/ul/?action=setPickup&client_id=&pickup=my_location&dropoff[formatted_address]=${encodedDest}`;
        };

        const getSubwayColor = (line) => {
            if (!line) return 'line-default';
            if (line.includes('1è™Ÿ')) return 'line-1';
            if (line.includes('2è™Ÿ')) return 'line-2';
            if (line.includes('3è™Ÿ')) return 'line-3';
            if (line.includes('4è™Ÿ')) return 'line-4';
            if (line.includes('5è™Ÿ')) return 'line-5';
            if (line.includes('9è™Ÿ')) return 'bg-[#BDB092] text-white'; 
            if (line.includes('AREX')) return 'line-arex';
            return 'bg-gray-500 text-white';
        };

        // --- 3. Firebase Logic ---
        const useFirebaseData = (defaultData) => {
            const [data, setData] = useState(defaultData);
            const [user, setUser] = useState(null);
            const [db, setDb] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                // Initialize Firebase with Config
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const firestore = getFirestore(app);
                const analytics = getAnalytics(app); // Initialize Analytics
                setDb(firestore);

                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Auth Error", error);
                    }
                };
                initAuth();

                const unsubscribeAuth = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if (u) {
                        const docRef = doc(firestore, 'trips', 'shared_trip_v1');
                        const unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                            if (docSnap.exists()) {
                                setData(docSnap.data());
                            } else {
                                setDoc(docRef, defaultData);
                            }
                            setLoading(false);
                        });
                        return () => unsubscribeSnapshot();
                    } else {
                         setLoading(false);
                    }
                });
                return () => unsubscribeAuth();
            }, []);

            const updateData = async (newData) => {
                // Optimistic Update
                setData(newData);
                if (db && user) {
                    try {
                        const docRef = doc(db, 'trips', 'shared_trip_v1');
                        await setDoc(docRef, { ...newData, lastUpdated: Date.now() });
                    } catch (error) {
                        console.error("Update Error", error);
                    }
                }
            };
            return { data, updateData, user, loading };
        };

        // --- 4. UI Components ---
        const WeatherWidget = ({ cityCode }) => { 
            const [weather, setWeather] = useState({ temp: '--', code: 0, rain: 0 });
            
            const coords = {
                'SEOUL': { lat: 37.5665, lon: 126.9780, name: 'SEOUL' },
                'OSAKA': { lat: 34.6937, lon: 135.5023, name: 'OSAKA' }
            };
            
            const current = coords[cityCode] || coords['SEOUL'];

            useEffect(() => {
                fetch(`https://api.open-meteo.com/v1/forecast?latitude=${current.lat}&longitude=${current.lon}&current_weather=true&daily=precipitation_probability_max&timezone=auto`)
                .then(res => res.json()).then(data => {
                    setWeather({ 
                        temp: Math.round(data.current_weather.temperature), 
                        code: data.current_weather.weathercode,
                        rain: data.daily?.precipitation_probability_max?.[0] || 0
                    });
                }).catch(e=>{});
            }, [cityCode]);

            const getIcon = (code) => code <= 3 ? <Sun className="w-8 h-8 text-yellow-400"/> : (code<=67 ? <CloudRain className="w-8 h-8 text-blue-300"/> : <Cloud className="w-8 h-8 text-stone-300"/>);
            return (
                <div className="absolute top-6 right-6 bg-white/60 backdrop-blur-md px-3 py-2 rounded-2xl shadow-sm flex items-center space-x-2 border border-white animate-in fade-in z-20">
                    {getIcon(weather.code)}
                    <div className="flex flex-col text-right">
                        <span className="text-lg font-black text-stone-600 leading-none">{weather.temp}Â°</span>
                        <span className="text-[10px] font-bold text-blue-500 flex items-center justify-end"><Umbrella size={8} className="mr-0.5"/>{weather.rain}%</span>
                        <span className="text-[9px] font-bold text-stone-400 uppercase tracking-wide">{current.name}</span>
                    </div>
                </div>
            );
        };

        const NaverMapBtn = ({ query }) => (
            <button onClick={(e) => { e.stopPropagation(); window.open(`https://map.naver.com/p/search/${encodeURIComponent(query)}`, '_blank'); }} className="bg-[#03C75A] hover:bg-[#02b351] text-white px-3 py-1.5 rounded-full shadow-sm transition-transform active:scale-90 flex items-center space-x-1">
                <span className="font-black text-[10px]">N</span><span className="text-[10px] font-bold">Map</span>
            </button>
        );

        const EditEventModal = ({ isOpen, onClose, event, onSave, onDelete }) => {
            const [formData, setFormData] = useState(event || {});
            useEffect(() => { setFormData(event || {}); }, [event]);
            if (!isOpen || !event) return null;

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center px-4 modal-overlay animate-in">
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden flex flex-col relative max-h-[80vh]">
                        <div className="p-4 bg-yellow-50 border-b border-yellow-100 flex justify-between items-center">
                            <h3 className="font-bold text-lg text-stone-800">ç·¨è¼¯è¡Œç¨‹</h3>
                            <button onClick={onClose}><X size={24} className="text-stone-400"/></button>
                        </div>
                        <div className="p-5 overflow-y-auto space-y-4">
                            <div><label className="block text-xs font-bold text-stone-400 mb-1">æ™‚é–“ (ä»¥æ­¤æ’åº)</label><input type="time" value={formData.time || ''} onChange={e => setFormData({...formData, time: e.target.value})} className="w-full p-3 bg-stone-50 rounded-xl border border-stone-200 font-bold text-lg"/></div>
                            <div><label className="block text-xs font-bold text-stone-400 mb-1">æ¨™é¡Œ</label><input type="text" value={formData.title || ''} onChange={e => setFormData({...formData, title: e.target.value})} className="w-full p-2 bg-stone-50 rounded-xl border border-stone-200 font-bold"/></div>
                            <div><label className="block text-xs font-bold text-stone-400 mb-1">æè¿°</label><textarea value={formData.description || ''} onChange={e => setFormData({...formData, description: e.target.value})} className="w-full h-24 p-2 bg-stone-50 rounded-xl border border-stone-200 text-sm"></textarea></div>
                            <div><label className="block text-xs font-bold text-stone-400 mb-1">å‚™è¨»</label><textarea value={formData.userNote || ''} onChange={e => setFormData({...formData, userNote: e.target.value})} className="w-full h-20 p-2 bg-yellow-50 rounded-xl border border-yellow-200 text-sm" placeholder="ç­†è¨˜..."></textarea></div>
                        </div>
                        <div className="p-4 border-t border-stone-100 flex space-x-3">
                            <button onClick={() => { if(confirm('ç¢ºå®šåˆªé™¤?')) onDelete(formData.id); }} className="p-3 rounded-xl text-red-500 bg-red-50"><Trash2 size={18}/></button>
                            <button onClick={() => onSave(formData)} className="flex-1 py-3 rounded-xl bg-stone-800 text-yellow-400 font-bold shadow-md">å„²å­˜ä¸¦è‡ªå‹•æ’åº</button>
                        </div>
                    </div>
                </div>
            );
        };

        const EditTicketModal = ({ isOpen, onClose, ticket, onSave }) => {
            const [formData, setFormData] = useState(ticket || {});
            useEffect(() => { setFormData(ticket || {}); }, [ticket]);
            if (!isOpen || !ticket) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center px-4 modal-overlay animate-in">
                    <div className="bg-white w-full max-w-sm rounded-3xl shadow-2xl overflow-hidden flex flex-col relative">
                        <div className="p-4 bg-blue-50 border-b border-blue-100 flex justify-between items-center"><h3 className="font-bold text-lg text-stone-800">ç·¨è¼¯ç¥¨åˆ¸</h3><button onClick={onClose}><X size={24} className="text-stone-400"/></button></div>
                        <div className="p-5 space-y-4">
                            <div><label className="text-xs text-stone-400 block">åç¨±</label><input value={formData.name || formData.traveler} onChange={e=>setFormData({...formData, [formData.name?'name':'traveler']:e.target.value})} className="w-full p-2 bg-stone-50 rounded-lg border font-bold"/></div>
                            <div><label className="text-xs text-stone-400 block">è¨‚ä½ä»£è™Ÿ</label><input value={formData.bookingRef} onChange={e=>setFormData({...formData, bookingRef:e.target.value})} className="w-full p-2 bg-blue-50 rounded-lg border border-blue-200 font-mono font-bold text-blue-800"/></div>
                            {formData.time && <div><label className="text-xs text-stone-400 block">æ™‚é–“</label><input value={formData.time} onChange={e=>setFormData({...formData, time:e.target.value})} className="w-full p-2 bg-stone-50 rounded-lg border font-bold"/></div>}
                        </div>
                        <div className="p-4 border-t border-stone-100"><button onClick={() => onSave(formData)} className="w-full py-3 rounded-xl bg-blue-600 text-white font-bold shadow-md">æ›´æ–°</button></div>
                    </div>
                </div>
            );
        };

        const CommuteCard = ({ from, to, options, guide }) => {
            const [showGuide, setShowGuide] = useState(false);
            return (
                <div className="bg-stone-50 rounded-3xl p-4 mb-4 border-2 border-stone-100 relative shadow-sm">
                    <div className="flex items-center justify-between mb-3 px-1">
                        <div className="flex items-center space-x-2 text-stone-600 font-bold"><Train size={18} className="text-yellow-500"/><span className="text-sm">äº¤é€šç§»å‹•</span></div>
                        {guide && <button onClick={() => setShowGuide(!showGuide)} className="text-[10px] bg-blue-100 text-blue-600 px-2 py-1 rounded-lg font-bold hover:bg-blue-200">{showGuide ? 'æ”¶èµ·' : 'æŒ‡å—'}</button>}
                    </div>
                    <div className="flex items-center justify-between text-sm font-bold text-stone-700 mb-4 bg-white p-3 rounded-2xl border border-stone-50 shadow-sm mx-1"><span>{from}</span><ArrowRight size={16} className="text-stone-300" /><span>{to}</span></div>
                    {showGuide && <div className="bg-blue-50 p-3 rounded-2xl mb-3 text-xs text-blue-800 leading-relaxed whitespace-pre-line border border-blue-100 animate-in fade-in slide-in-from-top-2"><div className="font-bold mb-1 flex items-center"><AlertCircle size={12} className="mr-1"/> æ³¨æ„ï¼š</div>{guide}</div>}
                    <div className="space-y-2">
                        {options.map((opt, idx) => (
                            <div key={idx} className="flex items-center justify-between bg-white p-3 rounded-2xl border border-stone-100 hover:border-yellow-200 transition-colors">
                                <div className="flex items-center space-x-3">
                                    {opt.type === 'subway' && opt.line ? (
                                        <span className={`px-2 py-1 rounded-lg text-[10px] font-bold tracking-wide ${getSubwayColor(opt.line)}`}>{opt.line}</span>
                                    ) : (
                                        <span className={`px-2 py-1 rounded-lg text-[10px] font-bold tracking-wide ${opt.type === 'subway' ? 'bg-emerald-400 text-white' : 'bg-stone-800 text-white'}`}>{opt.type === 'subway' ? 'åœ°éµ' : 'Taxi'}</span>
                                    )}
                                    <span className="text-xs font-bold text-stone-600">{opt.desc}</span>
                                </div>
                                <div className="text-right">
                                    <div className="font-black text-stone-800 text-sm">{opt.time}</div>
                                    {opt.type === 'subway' ? (
                                        <button onClick={()=>window.open(`https://map.naver.com/p/search/${encodeURIComponent(to)}`, '_blank')} className="mt-1 text-[10px] bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full font-bold flex items-center justify-end ml-auto"><MapIcon size={10} className="mr-1"/> è·¯ç·š</button>
                                    ) : (
                                        <button onClick={()=>openUber(to)} className="mt-1 text-[10px] bg-stone-800 text-white px-2 py-0.5 rounded-full font-bold flex items-center justify-end ml-auto"><Car size={10} className="mr-1"/> Uber</button>
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Views ---
        const TimelineView = ({ dayData, days, currentDayIdx, setDayIdx, onEditEvent, onAddEvent }) => {
            const getEventStyle = (type) => {
                switch(type) {
                    case 'food': return 'bg-orange-50 border-orange-100';
                    case 'shopping': return 'bg-pink-50 border-pink-100';
                    case 'sightseeing': return 'bg-green-50 border-green-100';
                    case 'flight': return 'bg-sky-50 border-sky-100';
                    default: return 'bg-white border-stone-100';
                }
            };

            return (
                <div className="pb-32">
                    <div className="bg-yellow-50 pt-14 pb-8 px-6 rounded-b-[3rem] relative mb-6 border-b border-yellow-100 overflow-hidden">
                        <div className="absolute top-6 left-6 z-10">
                            <h2 className="text-3xl font-black text-stone-800 tracking-tight drop-shadow-sm">{dayData.location}</h2>
                        </div>
                        <WeatherWidget cityCode={dayData.cityCode} />
                        <div className="mt-16 px-2">
                            <p className="text-stone-500 font-bold text-sm mb-4 ml-1">Day {dayData.day} Â· {dayData.date}</p>
                            <div className="flex space-x-3 overflow-x-auto no-scrollbar pb-2">
                                {days.map((d, idx) => (
                                    <button key={idx} onClick={() => setDayIdx(idx)} className={`px-5 py-2.5 rounded-2xl text-sm font-bold transition-all whitespace-nowrap border-2 ${idx === currentDayIdx ? "bg-stone-800 text-yellow-50 border-stone-800 shadow-lg scale-105" : "bg-white text-stone-400 border-white hover:border-yellow-200"}`}>{d.date.split(' ')[0]}</button>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="px-5 space-y-5">
                        {dayData.events.length === 0 && <div className="text-center text-stone-400 py-10">å°šç„¡è¡Œç¨‹ï¼Œé»æ“Šä¸‹æ–¹æ–°å¢</div>}
                        {dayData.events.map((event) => {
                            if (event.type === 'commute') return <CommuteCard key={event.id} from={event.from} to={event.to} options={event.options} guide={event.guide} />;
                            return (
                                <div key={event.id} onClick={() => onEditEvent(event)} className={`rounded-3xl p-5 border-2 flex items-start space-x-4 relative overflow-hidden group transition-all hover:shadow-md ${getEventStyle(event.type)}`}>
                                    <div className="flex flex-col items-center min-w-[50px] pt-1">
                                        <span className="text-sm font-black text-stone-600">{event.time}</span>
                                        {event.type === 'flight' && <Plane size={16} className="text-sky-400 mt-2 rotate-90"/>}
                                        {event.type === 'cake' && <Cake size={16} className="text-pink-400 mt-2"/>}
                                    </div>
                                    <div className="flex-1">
                                        <div className="flex justify-between items-start mb-1">
                                            <div><h3 className={`text-lg font-bold leading-tight ${event.type === 'flight' ? 'text-sky-900' : 'text-stone-800'}`}>{event.title}</h3>{event.koTitle && <p className="text-xs text-stone-400 font-medium mt-0.5">{event.koTitle}</p>}</div>
                                            <div className="flex space-x-2">{event.coords && <button onClick={(e)=>{e.stopPropagation();window.open(`https://map.naver.com/p/search/${encodeURIComponent(event.coords)}`)}} className="bg-[#03C75A] text-white px-2 py-1 rounded-lg text-xs font-bold">Map</button>}<Edit3 size={14} className="text-stone-300"/></div>
                                        </div>
                                        
                                        <div className="flex flex-wrap gap-2 my-2">
                                            {event.linePay && <div className="inline-flex items-center bg-[#00C300]/10 text-[#00C300] px-2 py-0.5 rounded-lg text-[10px] font-bold"><CreditCard size={10} className="mr-1"/> LINE Pay å„ªæƒ </div>}
                                            {event.coupon && <div className="inline-flex items-center bg-pink-100 text-pink-600 px-2 py-0.5 rounded-lg text-[10px] font-bold"><Tag size={10} className="mr-1"/> {event.coupon}</div>}
                                        </div>

                                        {event.flightInfo && <div className="bg-white/60 rounded-xl p-2 my-2 border border-sky-100 flex justify-between items-center text-xs"><span className="font-mono font-bold text-sky-600">{event.flightInfo.code}</span><span className="font-bold text-stone-600">{event.flightInfo.route}</span></div>}
                                        <div className={`text-sm leading-relaxed whitespace-pre-line ${event.type === 'flight' ? 'text-sky-800 opacity-80' : 'text-stone-600'}`}>{event.description}</div>
                                        {event.userNote && <div className="mt-3 bg-yellow-50 p-2 rounded-lg border border-yellow-100 flex items-start space-x-2 animate-in"><div className="bg-yellow-200 p-1 rounded-full mt-0.5"><Info size={10} className="text-yellow-800"/></div><p className="text-xs text-stone-700 font-medium">{event.userNote}</p></div>}
                                    </div>
                                </div>
                            );
                        })}
                        <button onClick={onAddEvent} className="w-full py-4 border-2 border-dashed border-stone-200 rounded-3xl text-stone-400 font-bold flex items-center justify-center hover:bg-white hover:border-yellow-300 hover:text-yellow-500 transition-all"><Plus size={20} className="mr-2"/> æ–°å¢è¡Œç¨‹</button>
                    </div>
                </div>
            );
        };

        const TicketsView = ({ data, onEditTicket }) => (
            <div className="pt-14 px-5 pb-32">
                <h1 className="text-3xl font-black text-stone-800 mb-6">æˆ‘çš„ç¥¨åˆ¸ ğŸŸï¸</h1>
                <section className="mb-8"><h2 className="text-xs font-bold text-sky-500 uppercase tracking-wider mb-3 ml-2 flex items-center"><Plane size={16} className="mr-2"/> Flights</h2><div className="space-y-4">{data.flights.map(f => (<div key={f.id} onClick={() => onEditTicket(f, 'flights')} className="bg-white rounded-3xl p-5 shadow-sm border-2 border-sky-100 relative overflow-hidden cursor-pointer active:scale-95 transition-transform"><div className="flex justify-between mb-4 pl-1"><span className="font-bold text-stone-700 flex items-center text-sm"><Plane size={16} className="mr-2 text-sky-400"/> {f.traveler}</span><span className="text-[10px] font-mono bg-sky-50 text-sky-700 px-2 py-1 rounded-lg font-bold">{f.code}</span></div><div className="flex justify-between items-center mb-5 px-2"><div className="text-center"><div className="text-2xl font-black text-stone-800">{f.origin.split(' ')[0]}</div><div className="text-xs text-stone-400 mt-1 font-bold">{f.depTime}</div></div><Plane size={20} className="text-sky-200 rotate-90" /><div className="text-center"><div className="text-2xl font-black text-stone-800">{f.dest.split(' ')[0]}</div><div className="text-xs text-stone-400 mt-1 font-bold">{f.arrTime}</div></div></div><div className="bg-sky-50/50 rounded-2xl p-3 text-xs space-y-2 text-stone-600 font-medium"><div className="flex justify-between"><span>è¨‚ä½ä»£è™Ÿ</span><span className="font-mono font-bold text-sky-700">{f.bookingRef}</span></div>{f.seat && <div className="flex justify-between"><span>åº§ä½</span><span className="font-bold">{f.seat}</span></div>}<div className="flex justify-between"><span>èˆªå»ˆ</span><span className="font-bold">{f.terminal}</span></div></div></div>))}</div></section>
                <section className="mb-8"><h2 className="text-sm font-black text-indigo-500 uppercase tracking-wider mb-3 ml-2 flex items-center"><Bed size={16} className="mr-2"/> Hotel</h2>{data.hotels.map(h => (<div key={h.id} onClick={() => onEditTicket(h, 'hotels')} className="bg-white rounded-3xl p-5 border-2 border-indigo-100 mb-4 cursor-pointer active:scale-95 transition-transform shadow-sm"><h3 className="font-bold text-lg text-stone-800">{h.name}</h3><p className="text-xs text-stone-500 mb-4 mt-1 font-medium">{h.address}</p><div className="grid grid-cols-2 gap-2 text-xs"><div className="bg-indigo-50 p-3 rounded-xl border border-indigo-100"><span className="text-[9px] text-indigo-400 block uppercase font-bold">Booking</span><span className="font-mono font-bold text-indigo-800">{h.bookingRef}</span></div><div className="bg-indigo-50 p-3 rounded-xl border border-indigo-100"><span className="text-[9px] text-indigo-400 block uppercase font-bold">Tel</span><span className="font-mono font-bold text-indigo-800">{h.phone}</span></div></div></div>))}</section>
                <section><h2 className="text-sm font-black text-orange-500 uppercase tracking-wider mb-3 ml-2 flex items-center"><Sparkles size={16} className="mr-2"/> Reservations</h2><div className="space-y-3">{data.reservations.map(r => { const Icon = getIconComponent(r.icon); return (<div key={r.id} onClick={() => onEditTicket(r, 'reservations')} className="bg-white rounded-3xl p-4 shadow-sm border-2 border-orange-100 flex flex-col justify-between cursor-pointer active:scale-95 transition-transform"><div className="flex items-center space-x-3 mb-3"><div className="bg-orange-100 p-2.5 rounded-full text-orange-500"><Icon size={18} strokeWidth={3}/></div><div><h3 className="font-bold text-stone-800 text-sm">{r.name}</h3><p className="text-[10px] text-stone-400 font-bold mt-0.5">{r.time} Â· {r.party}</p></div></div><div className="bg-orange-50 p-3 rounded-xl text-xs space-y-1 font-medium"><div className="flex justify-between"><span className="text-orange-400 font-bold">Booking</span><span className="font-mono font-bold text-orange-800">{r.bookingRef}</span></div>{r.phone && <div className="flex justify-between"><span className="text-orange-400 font-bold">Phone</span><span className="font-mono font-bold text-orange-800">{r.phone}</span></div>}{r.address && <div className="flex justify-between items-start mt-1"><span className="text-orange-400 font-bold whitespace-nowrap mr-2">Addr</span><span className="font-bold text-stone-600 text-right">{r.address}</span></div>}</div></div>)})}</div></section>
            </div>
        );

        const ImageModal = ({ src, onClose }) => {
            if (!src) return null;
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4" onClick={onClose}>
                    <button className="absolute top-4 right-4 text-white p-2"><X size={32}/></button>
                    <img src={src} alt="Full size" className="max-w-full max-h-full rounded-xl shadow-2xl" />
                </div>
            );
        }

        const RemindersView = ({ checklist, updateChecklist }) => {
            const [input, setInput] = useState("");
            const fileInputRef = useRef(null);
            const [activeTaskId, setActiveTaskId] = useState(null);
            const [previewImage, setPreviewImage] = useState(null);

            const addTask = () => { if(input.trim()){ updateChecklist([...checklist, {id:Date.now(), text:input, done:false, img:null}]); setInput(""); }};
            const toggleTask = (id) => updateChecklist(checklist.map(t=>t.id===id?{...t, done:!t.done}:t));
            const removeTask = (id) => updateChecklist(checklist.filter(t=>t.id!==id));
            const handleFileClick = (id) => { setActiveTaskId(id); fileInputRef.current.click(); };
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file && activeTaskId) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        updateChecklist(checklist.map(t=>t.id===activeTaskId ? {...t, img:reader.result} : t));
                        setActiveTaskId(null);
                    };
                    reader.readAsDataURL(file);
                }
            };
            const notify = () => {
                if ("Notification" in window && Notification.permission === "granted") new Notification("åˆ¥å¿˜äº†æª¢æŸ¥æ¸…å–®ï¼");
                else if ("Notification" in window && Notification.permission !== "denied") Notification.requestPermission().then(p=>{ if(p==="granted") new Notification("å·²é–‹å•Ÿæé†’åŠŸèƒ½ï¼"); });
                else alert("å·²è¨­å®šæé†’ï¼ (æ¨¡æ“¬)");
            };

            return (
                <div className="pt-14 px-5 pb-32 min-h-screen bg-stone-50">
                    <div className="flex justify-between items-end mb-4"><h1 className="text-3xl font-black text-stone-800">Checklist âœ…</h1><button onClick={notify} className="text-xs bg-yellow-300 px-3 py-1.5 rounded-xl font-bold shadow-sm active:scale-95">è¨­å®šæé†’</button></div>
                    <div className="flex space-x-2 mb-6"><input value={input} onChange={e=>setInput(e.target.value)} placeholder="æ–°å¢é …ç›®..." className="flex-1 p-3 rounded-xl border-none shadow-sm font-bold"/><button onClick={addTask} className="bg-stone-800 text-yellow-400 p-3 rounded-xl"><Plus/></button></div>
                    
                    <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} />
                    
                    <div className="space-y-3 mb-8">
                        {checklist.map(t => (
                            <div key={t.id} className="bg-white p-4 rounded-3xl shadow-sm">
                                <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center space-x-3 flex-1" onClick={()=>toggleTask(t.id)}>
                                        <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${t.done?'bg-green-400 border-green-400':'border-stone-200'}`}>{t.done && <CheckCircle size={14} className="text-white"/>}</div>
                                        <span className={`font-bold ${t.done?'line-through text-stone-300':'text-stone-700'}`}>{t.text}</span>
                                    </div>
                                    <div className="flex space-x-2">
                                        <button onClick={()=>handleFileClick(t.id)} className={`p-2 rounded-full ${t.img ? 'text-blue-500 bg-blue-100' : 'text-stone-300 bg-stone-50'}`}><Camera size={18}/></button>
                                        <button onClick={()=>removeTask(t.id)} className="text-stone-300 p-2"><Trash2 size={18}/></button>
                                    </div>
                                </div>
                                {t.img && (
                                    <div className="mt-2" onClick={() => setPreviewImage(t.img)}>
                                        <img src={t.img} className="w-full h-32 object-cover rounded-xl border-2 border-dashed border-stone-100 cursor-zoom-in" alt="uploaded"/>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>

                    {/* Subway Map Section */}
                    <div className="bg-stone-800 rounded-3xl p-5 text-white shadow-lg">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="font-bold text-lg flex items-center"><MapIcon className="mr-2 text-yellow-400"/> é¦–çˆ¾åœ°éµåœ–</h2>
                            <button onClick={()=>setPreviewImage("https://english.visitseoul.net/comm/getImage?srvcId=MAP&parentSn=1215")} className="text-xs bg-stone-600 px-3 py-1 rounded-full hover:bg-stone-500">å…¨è¢å¹•</button>
                        </div>
                        <div className="h-40 bg-stone-700 rounded-xl overflow-hidden cursor-pointer relative group" onClick={()=>setPreviewImage("https://english.visitseoul.net/comm/getImage?srvcId=MAP&parentSn=1215")}>
                             <img src="https://english.visitseoul.net/comm/getImage?srvcId=MAP&parentSn=1215" className="w-full h-full object-cover opacity-50 group-hover:opacity-80 transition-opacity" alt="Subway Map" />
                             <div className="absolute inset-0 flex items-center justify-center font-bold text-sm">é»æ“ŠæŸ¥çœ‹å¤§åœ–</div>
                        </div>
                    </div>

                    <ImageModal src={previewImage} onClose={() => setPreviewImage(null)} />
                </div>
            );
        };

        // --- App Main ---
        function App() {
            const [activeTab, setActiveTab] = useState('timeline');
            const [currentDayIdx, setCurrentDayIdx] = useState(0);
            const { data: trip, updateData, loading } = useFirebaseData(initialTripData);
            const [editEventModal, setEditEventModal] = useState({ isOpen: false, event: null });
            const [editTicketModal, setEditTicketModal] = useState({ isOpen: false, ticket: null, category: null });

            const sortEvents = (events) => events.sort((a, b) => a.time.localeCompare(b.time));
            const saveEvent = (updatedEvent) => {
                const newDays = trip.days.map((day, idx) => idx === currentDayIdx ? { ...day, events: sortEvents(day.events.map(ev => ev.id === updatedEvent.id ? updatedEvent : ev)) } : day);
                updateData({ ...trip, days: newDays });
                setEditEventModal({ isOpen: false, event: null });
            };
            const deleteEvent = (id) => {
                const newDays = trip.days.map((day, idx) => idx === currentDayIdx ? { ...day, events: day.events.filter(ev => ev.id !== id) } : day);
                updateData({ ...trip, days: newDays });
                setEditEventModal({ isOpen: false, event: null });
            };
            const addEvent = () => {
                const newEvent = { id: Date.now(), time: "12:00", title: "æ–°è¡Œç¨‹", location: "å¾…å®š", description: "...", type: "sightseeing" };
                const newDays = trip.days.map((day, idx) => idx === currentDayIdx ? { ...day, events: sortEvents([...day.events, newEvent]) } : day);
                updateData({ ...trip, days: newDays });
            };
            const saveTicket = (updatedTicket) => {
                const category = editTicketModal.category;
                const newTickets = { ...trip.tickets, [category]: trip.tickets[category].map(t => t.id === updatedTicket.id ? updatedTicket : t) };
                updateData({ ...trip, tickets: newTickets });
                setEditTicketModal({ isOpen: false, ticket: null, category: null });
            };
            
            const updateChecklist = (newChecklist) => {
                updateData({ ...trip, checklist: newChecklist });
            };

            if (loading) return <div className="flex h-screen items-center justify-center bg-stone-100 text-stone-400 font-bold animate-pulse">è¼‰å…¥é›²ç«¯è¡Œç¨‹ä¸­...</div>;

            return (
                <div className="min-h-screen bg-stone-50 font-sans max-w-md mx-auto shadow-2xl overflow-hidden relative text-stone-800 sm:rounded-[2.5rem] sm:border-[6px] sm:border-stone-100 sm:my-10">
                    {activeTab === 'timeline' && <TimelineView dayData={trip.days[currentDayIdx]} days={trip.days} currentDayIdx={currentDayIdx} setDayIdx={setCurrentDayIdx} onEditEvent={(e)=>setEditEventModal({isOpen:true, event:e})} onAddEvent={addEvent} />}
                    {activeTab === 'tickets' && <TicketsView data={trip.tickets} onEditTicket={(t,c)=>setEditTicketModal({isOpen:true, ticket:t, category:c})} />}
                    {activeTab === 'reminders' && <RemindersView checklist={trip.checklist || []} updateChecklist={updateChecklist} />}
                    
                    <EditEventModal isOpen={editEventModal.isOpen} onClose={() => setEditEventModal({isOpen: false, event: null})} event={editEventModal.event} onSave={saveEvent} onDelete={deleteEvent} />
                    <EditTicketModal isOpen={editTicketModal.isOpen} onClose={() => setEditTicketModal({isOpen: false, ticket: null})} ticket={editTicketModal.ticket} onSave={saveTicket} />

                    <div className="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-stone-900 text-stone-400 px-7 py-5 rounded-[2.5rem] shadow-xl flex items-center space-x-10 z-50">
                        <button onClick={() => setActiveTab('timeline')} className={`flex flex-col items-center transition-all ${activeTab === 'timeline' ? 'text-yellow-300 -translate-y-1' : ''}`}><MapPin size={24} strokeWidth={3} /><div className={`h-1.5 w-1.5 rounded-full mt-1.5 transition-opacity ${activeTab === 'timeline' ? 'bg-yellow-300 opacity-100' : 'opacity-0'}`}></div></button>
                        <button onClick={() => setActiveTab('tickets')} className={`flex flex-col items-center transition-all ${activeTab === 'tickets' ? 'text-yellow-300 -translate-y-1' : ''}`}><Ticket size={24} strokeWidth={3} /><div className={`h-1.5 w-1.5 rounded-full mt-1.5 transition-opacity ${activeTab === 'tickets' ? 'bg-yellow-300 opacity-100' : 'opacity-0'}`}></div></button>
                        <button onClick={() => setActiveTab('reminders')} className={`flex flex-col items-center transition-all ${activeTab === 'reminders' ? 'text-yellow-300 -translate-y-1' : ''}`}><Bell size={24} strokeWidth={3} /><div className={`h-1.5 w-1.5 rounded-full mt-1.5 transition-opacity ${activeTab === 'reminders' ? 'bg-yellow-300 opacity-100' : 'opacity-0'}`}></div></button>
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>